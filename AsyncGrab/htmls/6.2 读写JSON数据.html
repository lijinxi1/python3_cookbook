
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  
  <title>6.2 读写JSON数据 — python3-cookbook 3.0.0 文档</title>
  

  
  
  
  

  

  
  
    

  

  <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/_static/css/theme.css" rel="stylesheet" type="text/css"/>
  <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/genindex.html" rel="index" title="索引"/><script>
READTHEDOCS_DATA['page'] = 'c02/p02_match_text_at_start_end'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>
    <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/search.html" rel="search" title="搜索"/>
    <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/copyright.html" rel="copyright" title="版权所有"/>
    
     

  
  


<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/copyright.html" rel="canonical"/>

<link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/copyright.html" rel="stylesheet" type="text/css"/>



<!-- Add page-specific data, which must exist in the page js, not global -->




<!-- end RTD <extrahead> -->
</head>
    <body>
    <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
           <div itemprop="articleBody">
            
  <div class="section" id="json">
<h1>6.2 读写JSON数据<a class="headerlink" href="#json" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>问题<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>你想读写JSON(JavaScript Object Notation)编码格式的数据。</p>
</div>
<div class="section" id="id2">
<h2>解决方案<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">json</span></code> 模块提供了一种很简单的方式来编码和解码JSON数据。
其中两个主要的函数是 <code class="docutils literal notranslate"><span class="pre">json.dumps()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">json.loads()</span></code> ，
要比其他序列化函数库如pickle的接口少得多。
下面演示如何将一个Python数据结构转换为JSON：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'name'</span> <span class="p">:</span> <span class="s1">'ACME'</span><span class="p">,</span>
    <span class="s1">'shares'</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">'price'</span> <span class="p">:</span> <span class="mf">542.23</span>
<span class="p">}</span>

<span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>下面演示如何将一个JSON编码的字符串转换回一个Python数据结构：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
</pre></div>
</div>
<p>如果你要处理的是文件而不是字符串，你可以使用 <code class="docutils literal notranslate"><span class="pre">json.dump()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">json.load()</span></code> 来编码和解码JSON数据。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Writing JSON data</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'data.json'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># Reading data back</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'data.json'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>讨论<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>JSON编码支持的基本数据类型为 <code class="docutils literal notranslate"><span class="pre">None</span></code> ， <code class="docutils literal notranslate"><span class="pre">bool</span></code> ， <code class="docutils literal notranslate"><span class="pre">int</span></code> ， <code class="docutils literal notranslate"><span class="pre">float</span></code> 和 <code class="docutils literal notranslate"><span class="pre">str</span></code> ，
以及包含这些类型数据的lists，tuples和dictionaries。
对于dictionaries，keys需要是字符串类型(字典中任何非字符串类型的key在编码时会先转换为字符串)。
为了遵循JSON规范，你应该只编码Python的lists和dictionaries。
而且，在web应用程序中，顶层对象被编码为一个字典是一个标准做法。</p>
<p>JSON编码的格式对于Python语法而已几乎是完全一样的，除了一些小的差异之外。
比如，True会被映射为true，False被映射为false，而None会被映射为null。
下面是一个例子，演示了编码后的字符串效果：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="go">'false'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s1">'b'</span><span class="p">:</span> <span class="s1">'Hello'</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s1">'c'</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="go">'{"b": "Hello", "c": null, "a": true}'</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>如果你试着去检查JSON解码后的数据，你通常很难通过简单的打印来确定它的结构，
特别是当数据的嵌套结构层次很深或者包含大量的字段时。
为了解决这个问题，可以考虑使用pprint模块的 <code class="docutils literal notranslate"><span class="pre">pprint()</span></code> 函数来代替普通的 <code class="docutils literal notranslate"><span class="pre">print()</span></code> 函数。
它会按照key的字母顺序并以一种更加美观的方式输出。
下面是一个演示如何漂亮的打印输出Twitter上搜索结果的例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">json</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="s1">'http://search.twitter.com/search.json?q=python&amp;rpp=5'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
<span class="go">{'completed_in': 0.074,</span>
<span class="go">'max_id': 264043230692245504,</span>
<span class="go">'max_id_str': '264043230692245504',</span>
<span class="go">'next_page': '?page=2&amp;max_id=264043230692245504&amp;q=python&amp;rpp=5',</span>
<span class="go">'page': 1,</span>
<span class="go">'query': 'python',</span>
<span class="go">'refresh_url': '?since_id=264043230692245504&amp;q=python',</span>
<span class="go">'results': [{'created_at': 'Thu, 01 Nov 2012 16:36:26 +0000',</span>
<span class="go">            'from_user': ...</span>
<span class="go">            },</span>
<span class="go">            {'created_at': 'Thu, 01 Nov 2012 16:36:14 +0000',</span>
<span class="go">            'from_user': ...</span>
<span class="go">            },</span>
<span class="go">            {'created_at': 'Thu, 01 Nov 2012 16:36:13 +0000',</span>
<span class="go">            'from_user': ...</span>
<span class="go">            },</span>
<span class="go">            {'created_at': 'Thu, 01 Nov 2012 16:36:07 +0000',</span>
<span class="go">            'from_user': ...</span>
<span class="go">            }</span>
<span class="go">            {'created_at': 'Thu, 01 Nov 2012 16:36:04 +0000',</span>
<span class="go">            'from_user': ...</span>
<span class="go">            }],</span>
<span class="go">'results_per_page': 5,</span>
<span class="go">'since_id': 0,</span>
<span class="go">'since_id_str': '0'}</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>一般来讲，JSON解码会根据提供的数据创建dicts或lists。
如果你想要创建其他类型的对象，可以给 <code class="docutils literal notranslate"><span class="pre">json.loads()</span></code> 传递object_pairs_hook或object_hook参数。
例如，下面是演示如何解码JSON数据并在一个OrderedDict中保留其顺序的例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s1">'{"name": "ACME", "shares": 50, "price": 490.1}'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span>
<span class="go">OrderedDict([('name', 'ACME'), ('shares', 50), ('price', 490.1)])</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>下面是如何将一个JSON字典转换为一个Python对象例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">JSONObject</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>
<span class="gp">...</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">JSONObject</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="o">.</span><span class="n">name</span>
<span class="go">'ACME'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="o">.</span><span class="n">shares</span>
<span class="go">50</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="o">.</span><span class="n">price</span>
<span class="go">490.1</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>最后一个例子中，JSON解码后的字典作为一个单个参数传递给 <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> 。
然后，你就可以随心所欲的使用它了，比如作为一个实例字典来直接使用它。</p>
<p>在编码JSON的时候，还有一些选项很有用。
如果你想获得漂亮的格式化字符串后输出，可以使用 <code class="docutils literal notranslate"><span class="pre">json.dumps()</span></code> 的indent参数。
它会使得输出和pprint()函数效果类似。比如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="go">{"price": 542.23, "name": "ACME", "shares": 100}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<span class="go">{</span>
<span class="go">    "price": 542.23,</span>
<span class="go">    "name": "ACME",</span>
<span class="go">    "shares": 100</span>
<span class="go">}</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>对象实例通常并不是JSON可序列化的。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
    <span class="n">File</span> <span class="s2">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">File</span> <span class="s2">"/usr/local/lib/python3.3/json/__init__.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">226</span><span class="p">,</span> <span class="ow">in</span> <span class="n">dumps</span>
        <span class="k">return</span> <span class="n">_default_encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">File</span> <span class="s2">"/usr/local/lib/python3.3/json/encoder.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">187</span><span class="p">,</span> <span class="ow">in</span> <span class="n">encode</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterencode</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">_one_shot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">File</span> <span class="s2">"/usr/local/lib/python3.3/json/encoder.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">245</span><span class="p">,</span> <span class="ow">in</span> <span class="n">iterencode</span>
        <span class="k">return</span> <span class="n">_iterencode</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">File</span> <span class="s2">"/usr/local/lib/python3.3/json/encoder.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">169</span><span class="p">,</span> <span class="ow">in</span> <span class="n">default</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">+</span> <span class="s2">" is not JSON serializable"</span><span class="p">)</span>
<span class="gr">TypeError</span>: <span class="n">&lt;__main__.Point object at 0x1006f2650&gt; is not JSON serializable</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>如果你想序列化对象实例，你可以提供一个函数，它的输入是一个实例，返回一个可序列化的字典。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">serialize_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'__classname__'</span> <span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="p">}</span>
    <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>如果你想反过来获取这个实例，可以这样做：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dictionary mapping names to known classes</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'Point'</span> <span class="p">:</span> <span class="n">Point</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">unserialize_object</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">clsname</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'__classname__'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clsname</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="n">clsname</span><span class="p">]</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="c1"># Make instance without calling __init__</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>下面是如何使用这些函数的例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">serialize_instance</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span>
<span class="go">'{"__classname__": "Point", "y": 3, "x": 2}'</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">unserialize_object</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">&lt;__main__.Point object at 0x1017577d0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">x</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">y</span>
<span class="go">3</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">json</span></code> 模块还有很多其他选项来控制更低级别的数字、特殊值如NaN等的解析。
可以参考官方文档获取更多细节。</p>
</div>
</div>


           </div>
           
          </div>
    </body>
</html>