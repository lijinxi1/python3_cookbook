
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  
  <title>8.3 让对象支持上下文管理协议 — python3-cookbook 3.0.0 文档</title>
  

  
  
  
  

  

  
  
    

  

  <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/_static/css/theme.css" rel="stylesheet" type="text/css"/>
  <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/genindex.html" rel="index" title="索引"/><script>
READTHEDOCS_DATA['page'] = 'c02/p02_match_text_at_start_end'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>
    <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/search.html" rel="search" title="搜索"/>
    <link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/copyright.html" rel="copyright" title="版权所有"/>
    
     

  
  


<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/copyright.html" rel="canonical"/>

<link href="https://python3-cookbook.readthedocs.io/zh_CN/latest/copyright.html" rel="stylesheet" type="text/css"/>



<!-- Add page-specific data, which must exist in the page js, not global -->




<!-- end RTD <extrahead> -->
</head>
    <body>
    <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>8.3 让对象支持上下文管理协议<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>问题<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>你想让你的对象支持上下文管理协议(with语句)。</p>
</div>
<div class="section" id="id3">
<h2>解决方案<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>为了让一个对象兼容 <code class="docutils literal notranslate"><span class="pre">with</span></code> 语句，你需要实现 <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> 方法。
例如，考虑如下的一个类，它能为我们创建一个网络连接：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">socket</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span>

<span class="k">class</span> <span class="nc">LazyConnection</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Already connected'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_ty</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p>这个类的关键特点在于它表示了一个网络连接，但是初始化的时候并不会做任何事情(比如它并没有建立一个连接)。
连接的建立和关闭是使用 <code class="docutils literal notranslate"><span class="pre">with</span></code> 语句自动完成的，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">LazyConnection</span><span class="p">((</span><span class="s1">'www.python.org'</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="c1"># Connection closed</span>
<span class="k">with</span> <span class="n">conn</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="c1"># conn.__enter__() executes: connection open</span>
    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">'GET /index.html HTTP/1.0</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">'Host: www.python.org</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">,</span> <span class="mi">8192</span><span class="p">),</span> <span class="sa">b</span><span class="s1">''</span><span class="p">))</span>
    <span class="c1"># conn.__exit__() executes: connection closed</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>讨论<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>编写上下文管理器的主要原理是你的代码会放到 <code class="docutils literal notranslate"><span class="pre">with</span></code> 语句块中执行。
当出现 <code class="docutils literal notranslate"><span class="pre">with</span></code> 语句的时候，对象的 <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code> 方法被触发，
它返回的值(如果有的话)会被赋值给 <code class="docutils literal notranslate"><span class="pre">as</span></code> 声明的变量。然后，<code class="docutils literal notranslate"><span class="pre">with</span></code> 语句块里面的代码开始执行。
最后，<code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> 方法被触发进行清理工作。</p>
<p>不管 <code class="docutils literal notranslate"><span class="pre">with</span></code> 代码块中发生什么，上面的控制流都会执行完，就算代码块中发生了异常也是一样的。
事实上，<code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> 方法的第三个参数包含了异常类型、异常值和追溯信息(如果有的话)。
<code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> 方法能自己决定怎样利用这个异常信息，或者忽略它并返回一个None值。
如果 <code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> 返回 <code class="docutils literal notranslate"><span class="pre">True</span></code> ，那么异常会被清空，就好像什么都没发生一样，
<code class="docutils literal notranslate"><span class="pre">with</span></code> 语句后面的程序继续在正常执行。</p>
<p>还有一个细节问题就是 <code class="docutils literal notranslate"><span class="pre">LazyConnection</span></code> 类是否允许多个 <code class="docutils literal notranslate"><span class="pre">with</span></code> 语句来嵌套使用连接。
很显然，上面的定义中一次只能允许一个socket连接，如果正在使用一个socket的时候又重复使用 <code class="docutils literal notranslate"><span class="pre">with</span></code> 语句，
就会产生一个异常了。不过你可以像下面这样修改下上面的实现来解决这个问题：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">socket</span><span class="p">,</span> <span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span>

<span class="k">class</span> <span class="nc">LazyConnection</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sock</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_ty</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Example use</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">LazyConnection</span><span class="p">((</span><span class="s1">'www.python.org'</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="k">with</span> <span class="n">conn</span> <span class="k">as</span> <span class="n">s1</span><span class="p">:</span>
    <span class="k">pass</span>
    <span class="k">with</span> <span class="n">conn</span> <span class="k">as</span> <span class="n">s2</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1"># s1 and s2 are independent sockets</span>
</pre></div>
</div>
<p>在第二个版本中，<code class="docutils literal notranslate"><span class="pre">LazyConnection</span></code> 类可以被看做是某个连接工厂。在内部，一个列表被用来构造一个栈。
每次 <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code> 方法执行的时候，它复制创建一个新的连接并将其加入到栈里面。
<code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> 方法简单的从栈中弹出最后一个连接并关闭它。
这里稍微有点难理解，不过它能允许嵌套使用 <code class="docutils literal notranslate"><span class="pre">with</span></code> 语句创建多个连接，就如上面演示的那样。</p>
<p>在需要管理一些资源比如文件、网络连接和锁的编程环境中，使用上下文管理器是很普遍的。
这些资源的一个主要特征是它们必须被手动的关闭或释放来确保程序的正确运行。
例如，如果你请求了一个锁，那么你必须确保之后释放了它，否则就可能产生死锁。
通过实现 <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> 方法并使用 <code class="docutils literal notranslate"><span class="pre">with</span></code> 语句可以很容易的避免这些问题，
因为 <code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> 方法可以让你无需担心这些了。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">contextmanager</span></code> 模块中有一个标准的上下文管理方案模板，可参考9.22小节。
同时在12.6小节中还有一个对本节示例程序的线程安全的修改版。</p>
</div>
</div>


           </div>
           
          </div>
    </body>
</html>